[[getting-started-minion]]
= Getting started with a Minion

[[objectives]]
== Objectives

* Setting up a {page-component-title} Minion running on one of the following <<minion/system-requirements.adoc#operating-systems-Core, Operating Systems>>
* {page-component-title} Core comes with an embedded ActiveMQ message broker for convinience.
  This should not be used in production.
  It is only for getting started and testing.
* Create a dedicated Minion with credentials to secure the communication channels between the Minion and the Core instance
* Configure the communication channels with embedded ActiveMQ and REST between the {page-component-title} Core instance and the {page-component-title} Minion
* Verfying the setup

== Requirements

* Linux physical server or a virtual machine running a supported Linux operating system
* Internet access to download the installation packages
* Ensure DNS is configured, localhost and your servers host name is resolved properly
* {page-component-title} Core instance runs on latest stable release
* The Minion server can access the {page-component-title} Core instance via REST (8980/tcp) and ActiveMQ (616161/tcp)
* System user with administrative permissions (sudo) to perform the installation tasks

Configuring a Minion requires the following information and you have to adapt them accordingly:

* Web UI URL for your OpenNMS {page-component-title} Core instance, we use `\http://core-instance-ip:8980/opennms` as an example.
* ActiveMQ endpoint and if it's SSL or plain text TCP, we use `failover:tcp://core-instance-ip:61616` as an example.
  The Core instance network endpoint is indicated with `core-instance-ip`, it can also be a FQDN.
* Credentials for the Minion user for the Core instance and Minion communication channels, we use `my-minion-user` and `my-minion-password` as an example.

ifeval::["{page-component-title}" == "Horizon"]
CAUTION: If you run Debian, you have to install and configure `sudo` yourself.
         A guide can be found in the link:https://wiki.debian.org/sudo/[Debian Wiki].
endif::[]

[[prepare-Core-server]]
== Prepare {page-component-title} Core Instance

The communication between {page-component-title} Core instance and the Minion is secured with credentials.
We use here as example the user _my-minion-user_ with password _my-minion-password_.
The credentials are used for authenticating the REST endpoint and ActiveMQ message broker.

IMPORTANT: Replace at least _my-minion-password_ with a secure password.

=== Create a minion user

. Log in to the web UI as an administrative user
. Click on the gears icon and choose btn:[Configure Users, Groups and On-Call Roles] -> btn:[Configure Users]
. Add a new user with login name _my-minion-user_ and password _my-minion-password_ and click btn:[OK]
. In the *Security Roles* area, assign the _ROLE_MINION_ security role
.. Optional: fill in a comment for the Minion user's location and purpose
. Click btn:[Finish]

The new created Minion user should now be listed in the user List.

=== Enable embedded ActiveMQ

With the {page-component-title} Core instance comes an embedded ActiveMQ message broker which listens by default on the local loopback interface.
Allowing Minions to communicate with the {page-component-title} Core instance requires to change the listening interface to all public network interfaces.

[{tabs}]
====
CentOS/RHEL 7/8::
+
--
include::centos-rhel/step-1-configure-core.adoc[]
--

ifeval::["{page-component-title}" == "Horizon"]
Debian/Ubuntu::
+
--
include::debian-ubuntu/step-1-configure-core.adoc[]
--
endif::[]
====

== Installing the Minion package

[{tabs}]
====
CentOS/RHEL 7::
+
--
include::centos-rhel7/step-2-install-minion.adoc[]
--

CentOS/RHEL 8::
+
--
include::centos-rhel8/step-2-install-minion.adoc[]
--

ifeval::["{page-component-title}" == "Horizon"]
Debian::
+
--
include::debian/step-2-install-minion.adoc[]
--

Ubuntu::
+
--
include::ubuntu/step-2-install-minion.adoc[]
--
endif::[]
====

== Configure the Minion

.Connect to the Karaf shell with user `admin` and password `admin`
[source, console]
----
ssh -p 8201 admin@localhost
----

.Configure REST endpoints, ActiveMQ and remote location name
[source,karaf]
----
config:edit org.opennms.minion.controller<1>
config:property-set location Office-Pittsboro<2>
config:property-set http-url http://core-instance-ip:8980/opennms<3>
config:property-set broker-url failover:tcp://core-instance-ip:61616<4>
config:update<5>
----
<1> Change mode to edit the minion configuration
<2> Replace Office-Pittsboro with a location name representing your remote location the Minion is running
<3> Replace the example `http-url` with the URL of your {page-component-title} Core instance
<4> Replace the example `broker-url` with the host of your {page-component-title} Core instance. If you have ActiveMQ with SSL running replace `tcp` with `ssl`.
<5> Save the configuration

TIP: By default the Minion generates a unique id.
     If you want to provide a human readable Minion identifier yourself with `config:property-set id my-minion-name`

.Configure the credentials and exit Karaf shell
[source,karaf]
----
opennms:scv-set opennms.http my-minion-user my-minion-password<1>
opennms:scv-set opennms.broker my-minion-user my-minion-password<2>
----
<1> Set the credentials for the REST endpoint created in your {page-component-title} Core instance
<2> Set the credentials for the ActiveMQ message broker

NOTE: The credentials are encrypted on disk in `$MINION_HOME/etc/scv.jce`.

Exit the Karaf Shell with kbd:[Ctrl+d]

.Restart the Minion to apply the configuration
[source,console]
----
sudo systemctl restart minion
----

== Secure Access to Karaf Shell

IMPORTANT: Change the default user/password _admin/admin_ for the Karaf shell and encrypt it.

[{tabs}]
====
CentOS/RHEL 7/8::
+
--
include::centos-rhel/step-4-secure-karaf.adoc[]
--

ifeval::["{page-component-title}" == "Horizon"]
Debian/Ubuntu::
+
--
include::debian-ubuntu/step-4-secure-karaf.adoc[]
--
endif::[]
====

TIP: Changing the password or encryption algorithm get applied immediately.
     It is not required to restart the Minion

TIP: By default the Karaf Shell is restricted to 127.0.0.1.
     If you want enable remote access, set `sshHost=0.0.0.0` in `org.apache.karaf.shell.cfg`.
     The change is applied immediately and a Minion restart is not required.
     If you have firewall running on your host, allow `8201/tcp` to grant access to the Karaf Shell.

== Verify Connectivity

You can test if your Minion can communicate with the {page-component-title} Core instance with your given configuration.

.Connect to the Karaf shell
[source,console]
----
ssh -p 8201 admin@localhost
----

.Run the health check to verify connectivity
[source,karaf]
----
opennms:health-check
----

.The result should show Success for each component
[source,output]
----
Connecting to OpenNMS ReST API   [ Success  ]
Verifying installed bundles      [ Success  ]
Connecting to JMS Broker         [ Success  ]
=> Everything is awesome
----

== Check Minion in the Core web UI

. Log in to the web UI as an administrative user
. Click on the gears icon and choose btn:[Manage Minions]

After a few minutes your Minion should be provisioned automatically and the status should be _up_.
